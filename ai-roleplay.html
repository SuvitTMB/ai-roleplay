<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Voice Roleplay Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            padding-top: 64px; 
        }
        .font-inter {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #475569;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #334155;
             transform: translateY(-2px);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .chat-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
        }
        .user-bubble {
            background-color: #2563eb;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-bubble {
            background-color: #e2e8f0;
            color: #1e293b;
            border-bottom-left-radius: 0.25rem;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login View -->
    <div id="login-view" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-[100] transition-opacity duration-300">
        <div class="w-full max-w-md p-8 bg-white rounded-2xl shadow-2xl">
            <div class="text-center">
                 <i class="fas fa-brain text-5xl text-blue-600"></i>
                <h2 class="mt-4 text-3xl font-bold text-slate-800">SalesSim Login</h2>
                <p class="text-slate-500 mb-8">กรุณากรอกข้อมูลเพื่อเข้าสู่ระบบ</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="employee-id" class="block text-sm font-medium text-slate-600">รหัสพนักงาน</label>
                    <input type="text" id="employee-id" class="mt-1 block w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 12345">
                </div>
                 <div>
                    <label for="employee-name" class="block text-sm font-medium text-slate-600">ชื่อ-นามสกุล</label>
                    <input type="text" id="employee-name" class="mt-1 block w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., สมชาย ชาญชัย">
                </div>
                <button id="login-btn" class="w-full btn-primary py-3 px-4 rounded-lg text-base">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <!-- Main View: Customer Selection -->
    <main id="main-content" class="container mx-auto p-4 md:p-8 hidden">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">AI Sales Voice Roleplay Simulator</h1>
            <p class="text-lg text-slate-600 mt-2">เลือกโปรไฟล์ลูกค้าเพื่อเริ่มการสนทนาจำลอง</p>
        </header>
        <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8">
            <!-- Customer cards will be injected here by JavaScript -->
        </div>
    </main>

    <!-- Roleplay View -->
    <div id="roleplay-view" class="hidden fixed inset-0 h-screen w-screen flex flex-col bg-white z-50">
        <!-- Header -->
        <div class="p-4 md:p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="back-to-list-btn" class="btn-secondary py-2 px-4 !rounded-lg flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>
                        กลับไป
                    </button>
                    <button id="show-roleplay-info-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                        <i class="fas fa-info-circle"></i>
                        ข้อมูลลูกค้า
                    </button>
                    <button id="end-chat-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors disabled:bg-red-300 disabled:cursor-not-allowed">
                        <i class="fas fa-flag-checkered"></i>
                        จบการสนทนา
                    </button>
                </div>
                <div id="roleplay-customer-profile" class="flex items-center gap-4">
                    <!-- Profile info will be injected here -->
                </div>
            </div>
        </div>
        
        <!-- Conversation Context -->
        <div id="conversation-context" class="p-3 bg-blue-50 border-b border-blue-200 text-sm text-blue-800">
            <!-- Context will be injected here -->
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar bg-slate-50">
            <!-- Chat messages will be appended here -->
        </div>

        <!-- Input Controls (Voice Version) -->
        <div class="p-4 border-t border-slate-200 flex flex-col items-center justify-center gap-4">
            <button id="mic-btn" class="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white rounded-full w-20 h-20 flex items-center justify-center text-3xl transition-all duration-300 shadow-lg">
                <i class="fas fa-microphone"></i>
            </button>
            <p id="status-indicator" class="text-slate-500 text-sm h-5">แตะไมโครโฟนเพื่อเริ่มพูด</p>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="info-modal" class="fixed inset-0 z-[60] hidden items-center justify-center modal-backdrop">
        <div class="card p-8 max-w-2xl w-full mx-4 relative text-slate-700 flex flex-col">
             <div id="info-modal-content"></div>
             <div class="mt-8 text-center">
                 <button onclick="closeInfoModal()" class="btn-secondary py-2 px-6">ปิด</button>
             </div>
        </div>
    </div>

    <div id="evaluation-modal" class="fixed inset-0 z-[60] hidden items-center justify-center modal-backdrop">
        <div class="card p-8 max-w-2xl w-full mx-4 relative" style="max-width: 80% !important;">
            <h2 class="text-3xl font-bold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">ผลการประเมิน</h2>
            <div id="evaluation-content" class="space-y-6"></div>
            <div class="text-center mt-8">
                <button onclick="closeEvaluationModalAndReset()" class="btn-primary py-2 px-6">ปิด</button>
            </div>
             <button onclick="closeEvaluationModalAndReset()" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
        </div>
    </div>
    
    <script>
        const customers = [
            { id: 1, name: 'สมชาย เกียรติสกุล', age: 62, gender: 'male', image: 'https://i.imgur.com/r6p6JjY.png', title: 'Senior Business Owner', segment: 'Platinum', riskAppetite: 'Conservative', details: {'Suitability Score': '1', 'Main bank': 'เป็น', 'ttb Payroll': 'ไม่เป็น', 'เคยซื้อ Structured Note': 'ไม่เคย', 'เคยซื้อหุ้นกู้ (Bond)': 'ไม่เคย', 'เคยซื้อ MF Type B': 'ไม่เคย', 'เคยซื้อกองทุนลดหย่อนภาษี': 'เคย', 'เคยมีประสบการณ์ FX': 'ไม่เคย'}, summary: 'ผมเป็นเจ้าของธุรกิจใหญ่ใกล้เกษียณ มีความมั่งคั่งสูง แต่กังวลเรื่องความเสี่ยงและเน้นการรักษาเงินต้นเป็นหลัก สนใจการลงทุนที่ให้ผลตอบแทนดีกว่าเงินฝากแต่ต้องปลอดภัยสูง', personaPrompt: 'คุณคือ สมชาย เกียรติสกุล, เจ้าของธุรกิจวัย 62 ปีที่ประสบความสำเร็จและกำลังวางแผนเกษียณ คุณเป็นคนรอบคอบมากเรื่องการเงิน ไม่ชอบความเสี่ยง และให้ความสำคัญกับการรักษาเงินต้นสูงสุด คุณมีประสบการณ์ลงทุนในกองทุนลดหย่อนภาษีบ้าง แต่ไม่เคยแตะผลิตภัณฑ์ที่ซับซ้อน เป้าหมายของคุณคือหาผลตอบแทนที่ชนะเงินเฟ้อโดยไม่ต้องเสี่ยงมากเกินไป คุณจะรอให้พนักงานเป็นฝ่ายเริ่มบทสนทนาก่อนเสมอ' },
            { id: 2, name: 'อลิสา วัฒนากุล', age: 35, gender: 'female', image: 'https://i.imgur.com/O2h5vDb.png', title: 'Tech Startup Founder', segment: 'Gold', riskAppetite: 'Growth Investor', details: {'Suitability Score': '4', 'Main bank': 'ไม่เป็น', 'ttb Payroll': 'ไม่เป็น', 'เคยซื้อ Structured Note': 'เคย', 'เคยซื้อหุ้นกู้ (Bond)': 'เคย', 'เคยซื้อ MF Type B': 'เคย', 'เคยซื้อกองทุนลดหย่อนภาษี': 'ไม่เคย', 'เคยมีประสบการณ์ FX': 'เคย'}, summary: 'ดิฉันเป็นผู้ก่อตั้งสตาร์ทอัพด้านเทคโนโลยี มีรายได้สูงและยอมรับความเสี่ยงได้ดี มองหาการลงทุนที่เติบโตสูงในระยะยาว และสนใจนวัตกรรมการเงินใหม่ๆ', personaPrompt: 'คุณคือ อลิสา วัฒนากุล, CEO สตาร์ทอัพเทคโนโลยีวัย 35 ปี คุณมีความเข้าใจในเทคโนโลยีเป็นอย่างดีและยอมรับความเสี่ยงได้สูงเพื่อผลตอบแทนที่คุ้มค่า คุณมองหาการลงทุนที่จะช่วยต่อยอดความมั่งคั่งอย่างรวดเร็ว และไม่กลัวความผันผวนในระยะสั้น คุณจะรอให้พนักงานเป็นฝ่ายเริ่มบทสนทนาก่อนเสมอ' },
            { id: 3, name: 'ปรีชา ตั้งใจจริง', age: 45, gender: 'male', image: 'https://i.imgur.com/Q9p5d7A.png', title: 'Government Officer', segment: 'Silver', riskAppetite: 'Balanced', details: {'Suitability Score': '3', 'Main bank': 'เป็น', 'ttb Payroll': 'เป็น', 'เคยซื้อ Structured Note': 'ไม่เคย', 'เคยซื้อหุ้นกู้ (Bond)': 'เคย', 'เคยซื้อ MF Type B': 'เคย', 'เคยซื้อกองทุนลดหย่อนภาษี': 'เคย', 'เคยมีประสบการณ์ FX': 'ไม่เคย'}, summary: 'ผมเป็นข้าราชการระดับสูง มีความมั่นคงในอาชีพ ต้องการวางแผนการเงินเพื่อการศึกษาบุตรและวัยเกษียณ รับความเสี่ยงได้ปานกลาง เน้นการลงทุนแบบสมดุล', personaPrompt: 'คุณคือ ปรีชา ตั้งใจจริง, ข้าราชการวัย 45 ปี คุณมีเป้าหมายทางการเงินที่ชัดเจนคือเพื่อการศึกษาของลูกและเพื่อการเกษียณอย่างสุขสบาย คุณไม่ต้องการความเสี่ยงที่สูงเกินไป แต่ก็เข้าใจว่าการฝากเงินอย่างเดียวไม่เพียงพอ คุณมองหาการลงทุนที่สมดุลระหว่างการเติบโตและความมั่นคง คุณจะรอให้พนักงานเป็นฝ่ายเริ่มบทสนทนาก่อนเสมอ'},
            { id: 4, name: 'มาลินี สดใส', age: 28, gender: 'female', image: 'https://i.imgur.com/emily.png', title: 'Freelance Designer', segment: 'Basic', riskAppetite: 'Pure Deposit', details: {'Suitability Score': '2', 'Main bank': 'เป็น', 'ttb Payroll': 'ไม่เป็น', 'เคยซื้อ Structured Note': 'ไม่เคย', 'เคยซื้อหุ้นกู้ (Bond)': 'ไม่เคย', 'เคยซื้อ MF Type B': 'ไม่เคย', 'เคยซื้อกองทุนลดหย่อนภาษี': 'ไม่เคย', 'เคยมีประสบการณ์ FX': 'ไม่เคย'}, summary: 'ฉันเป็นดีไซน์เนอร์ฟรีแลนซ์ค่ะ เพิ่งเริ่มสร้างตัวและเก็บเงิน มีความรู้ด้านการเงินจำกัด ต้องการลงทุนที่เข้าใจง่าย ความเสี่ยงต่ำ และมีสภาพคล่อง', personaPrompt: 'คุณคือ มาลินี สดใส, ฟรีแลนซ์ดีไซน์เนอร์วัย 28 ปี คุณเพิ่งเริ่มอาชีพและกำลังสร้างความมั่นคงทางการเงิน คุณกลัวการขาดทุนและอยากเริ่มต้นลงทุนกับอะไรที่ปลอดภัย เข้าใจง่าย และสามารถนำเงินออกมาใช้ได้เมื่อจำเป็น คุณจะรอให้พนักงานเป็นฝ่ายเริ่มบทสนทนาก่อนเสมอ'},
            { id: 5, name: 'วิลเลียม เฉิน', age: 50, gender: 'male', image: 'https://i.imgur.com/michael.png', title: 'Expat Executive', segment: 'Platinum', riskAppetite: 'Aggressive', details: {'Suitability Score': '5', 'Main bank': 'ไม่เป็น', 'ttb Payroll': 'ไม่เป็น', 'เคยซื้อ Structured Note': 'เคย', 'เคยซื้อหุ้นกู้ (Bond)': 'เคย', 'เคยซื้อ MF Type B': 'เคย', 'เคยซื้อกองทุนลดหย่อนภาษี': 'เคย', 'เคยมีประสบการณ์ FX': 'เคย'}, summary: 'ผมเป็นผู้บริหารชาวต่างชาติที่ทำงานในไทย มีความรู้ด้านการลงทุนเป็นอย่างดีและรับความเสี่ยงได้สูงมาก มองหาโอกาสการลงทุนทั่วโลกเพื่อสร้างผลตอบแทนสูงสุด', personaPrompt: 'คุณคือ วิลเลียม เฉิน, ผู้บริหารระดับสูงวัย 50 ปี คุณมีประสบการณ์การลงทุนทั่วโลกและมองหาผลตอบแทนที่ดีที่สุดเสมอ คุณไม่กลัวความเสี่ยงและสนใจผลิตภัณฑ์การเงินที่ซับซ้อนที่สามารถสร้าง Alpha ได้ คุณต้องการคุยกับที่ปรึกษาที่เข้าใจตลาดโลกและนำเสนอไอเดียที่น่าสนใจได้ คุณจะรอให้พนักงานเป็นฝ่ายเริ่มบทสนทนาก่อนเสมอ'},
        ];

        const loginView = document.getElementById('login-view');
        const mainContent = document.getElementById('main-content');
        const loginBtn = document.getElementById('login-btn');
        const employeeIdInput = document.getElementById('employee-id');
        const employeeNameInput = document.getElementById('employee-name');
        
        const roleplayView = document.getElementById('roleplay-view');
        const infoModal = document.getElementById('info-modal');
        const infoModalContent = document.getElementById('info-modal-content');
        const evaluationModal = document.getElementById('evaluation-modal');
        const evaluationContent = document.getElementById('evaluation-content');
        
        const chatContainer = document.getElementById('chat-container');
        const endChatButton = document.getElementById('end-chat-btn');
        const showRoleplayInfoButton = document.getElementById('show-roleplay-info-btn');
        const contextContainer = document.getElementById('conversation-context');

        // --- Voice Control Elements ---
        const micBtn = document.getElementById('mic-btn');
        const statusIndicator = document.getElementById('status-indicator');

        let currentUser = null;
        let conversationHistory = [];
        let currentCustomer = null;
        let turnCount = 0;
        const maxTurns = 5;
        let isEvaluationInProgress = false;
        let voices = [];

        loginBtn.addEventListener('click', () => {
            const employeeId = employeeIdInput.value.trim();
            const employeeName = employeeNameInput.value.trim();
            if (employeeId && employeeName) {
                currentUser = { id: employeeId, name: employeeName };
                loginView.classList.add('hidden');
                mainContent.classList.remove('hidden');
                renderCustomers();
            } else {
                alert('กรุณากรอกรหัสพนักงานและชื่อ-นามสกุล');
            }
        });

        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
        }
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        const speakText = (text, gender = 'female') => {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH';
                utterance.rate = 0.95;

                const thaiVoices = voices.filter(v => v.lang === 'th-TH');
                if (thaiVoices.length > 0) {
                    let selectedVoice = gender === 'male' ? thaiVoices.find(v => v.name.includes('Pattara')) : null;
                    if (!selectedVoice) selectedVoice = thaiVoices[0]; // fallback
                    utterance.voice = selectedVoice;
                }
                
                // --- Seamless Conversation Logic ---
                // When AI finishes speaking, start listening for the user's voice
                utterance.onend = () => {
                   setTimeout(() => {
                        if (!isRecording && !isEvaluationInProgress) {
                            recognition.start();
                        }
                   }, 500); // Small delay
                };
                
                window.speechSynthesis.speak(utterance);
            }, 100);
        };

        function renderCustomers() {
            const customerGridView = document.getElementById('customer-grid');
            customerGridView.innerHTML = '';
            customers.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'card p-6 flex flex-col items-center text-center space-y-4';
                card.innerHTML = `
                    <img src="${customer.image}" alt="${customer.name}" class="w-32 h-32 rounded-full object-cover border-4 border-slate-200">
                    <div>
                        <h3 class="text-xl font-bold">${customer.name}</h3>
                        <p class="text-slate-500">${customer.title} (อายุ: ${customer.age} ปี)</p>
                    </div>
                    <div class="flex space-x-2 w-full">
                        <button onclick="showCustomerInfo(${customer.id})" class="flex-1 btn-secondary py-2 px-4 !text-sm">ข้อมูลลูกค้า</button>
                        <button onclick="startRoleplay(${customer.id})" class="flex-1 btn-primary py-2 px-4 !text-sm">เริ่มสนทนา</button>
                    </div>
                `;
                customerGridView.appendChild(card);
            });
        }
        
        window.showCustomerInfo = (id) => {
            const customer = customers.find(c => c.id === id);
            infoModalContent.innerHTML = `
                <div class="flex flex-col md:flex-row items-center gap-8">
                    <div class="flex-shrink-0 text-center">
                        <img src="${customer.image}" alt="${customer.name}" class="w-40 h-40 rounded-full object-cover border-4 border-slate-200 mx-auto">
                        <h3 class="text-2xl font-bold mt-4">${customer.name} (${customer.age} ปี)</h3>
                        <p class="text-blue-600 font-semibold">${customer.title}</p>
                        <div class="flex justify-center gap-2 mt-2">
                             <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${customer.segment}</span>
                             <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${customer.riskAppetite}</span>
                        </div>
                    </div>
                    <div class="w-full">
                        <h4 class="text-lg font-semibold border-b border-slate-200 pb-2 mb-3">ข้อมูลเบื้องต้น</h4>
                        <p class="text-sm text-slate-600 mb-4 bg-slate-50 p-3 rounded-lg">${customer.summary}</p>
                        <ul class="space-y-1 text-sm">
                            ${Object.entries(customer.details).map(([key, value]) => `
                                <li class="flex justify-between"><span class="text-slate-500">${key}:</span> <strong>${value}</strong></li>
                            `).join('')}
                        </ul>
                    </div>
                </div>`;
            infoModal.classList.remove('hidden');
            infoModal.classList.add('flex');
        };

        window.closeInfoModal = () => {
            infoModal.classList.add('hidden');
            infoModal.classList.remove('flex');
        };

        window.startRoleplay = (id) => {
            currentCustomer = customers.find(c => c.id === id);
            turnCount = 0;
            isEvaluationInProgress = false;
            conversationHistory = [{ role: 'system', parts: [{ text: `${currentCustomer.personaPrompt}\nบทสนทนาต้องไม่เกิน ${maxTurns} คู่ (คุณถาม ${maxTurns} ครั้ง ฉันตอบ ${maxTurns} ครั้ง)` }] }];
            
            document.getElementById('roleplay-customer-profile').innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-right">${currentCustomer.name}</h3>
                    <p class="text-sm text-slate-500 text-right">อายุ: ${currentCustomer.age} ปี</p>
                </div>
                <img src="${currentCustomer.image}" alt="${currentCustomer.name}" class="w-14 h-14 rounded-full border-2 border-blue-500">
            `;
            contextContainer.innerHTML = `<p><strong class="font-semibold">กำลังสนทนากับ:</strong> ${currentCustomer.name} (${currentCustomer.age} ปี)</p>
            <p><strong class="font-semibold">หัวข้อ:</strong> ${currentCustomer.summary}</p>`;
            chatContainer.innerHTML = '';
            
            mainContent.classList.add('hidden');
            roleplayView.classList.remove('hidden');
            
            // Start the conversation by having the AI "wait" for the user.
            // A greeting could be added here if desired.
            setTimeout(() => {
                if (!isRecording && recognition) {
                    recognition.start();
                }
            }, 1000);
        };
        
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
             if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
             if (isRecording) recognition.stop();
             roleplayView.classList.add('hidden');
             mainContent.classList.remove('hidden');
        });

        const addUserMessage = (container, text) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-bubble self-end user-bubble';
            messageEl.innerHTML = `<p class="font-semibold mb-1">คุณ (${currentUser.name})</p><p>${text}</p>`;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        };

        const addAiMessage = (container, customerName, text) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-bubble self-start ai-bubble';
            messageEl.innerHTML = `<p class="font-semibold mb-1">${customerName} (AI)</p><div class="ai-response-text">${text}</div>`;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            return messageEl.querySelector('.ai-response-text');
        };

        const handleUserTurn = async (userMessage) => {
            turnCount++;
            conversationHistory.push({ role: 'user', parts: [{ text: userMessage }] });

            const thinkingMessage = addAiMessage(chatContainer, currentCustomer.name, '<i class="fas fa-spinner fa-spin"></i> กำลังคิด...');
            
            micBtn.disabled = true;

            const aiResponse = await getAIResponse(conversationHistory);
            conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
            
            thinkingMessage.innerHTML = aiResponse;
            speakText(aiResponse, currentCustomer.gender);
            
            micBtn.disabled = false;
            
            if (turnCount >= maxTurns) {
                endChatButton.disabled = false;
            }
        };
        
        async function getAIResponse(history) {
            try {
                const payload = {
                    "contents": history.slice(1), // Exclude system prompt from contents
                    "systemInstruction": history[0]
                };
                const responseText = await callGemini(payload);
                return responseText;
            } catch (error) {
                console.error("Error in getAIResponse:", error);
                return `เกิดข้อผิดพลาด: ${error.message}`;
            }
        }

        endChatButton.addEventListener('click', () => {
            if (!isEvaluationInProgress) {
                getFinalEvaluation();
            }
        });

        showRoleplayInfoButton.addEventListener('click', () => {
            if (currentCustomer) {
                showCustomerInfo(currentCustomer.id);
            }
        });

        async function getFinalEvaluation() {
            if (isEvaluationInProgress) return;
            isEvaluationInProgress = true;
            micBtn.disabled = true;
            if(isRecording) recognition.stop();
            
            addAiMessage(chatContainer, currentCustomer.name, 'บทสนทนาสิ้นสุดแล้ว กำลังสร้างผลประเมิน...');

            const evaluationPrompt = `Based on the entire conversation, evaluate the employee's sales performance as the customer (${currentCustomer.name}). Provide a fair and balanced evaluation with moderately strict scoring, avoiding extreme scores unless clearly justified. Score each criterion out of 15: 1. Product Knowledge 2. Sales Presentation Skills 3. Clear Sales Process 4. Employee's Expertise 5. Closing Ability. Calculate the Total Score (max 75). Provide a summary of Strengths and Improvements. Respond in Thai and JSON format only: {"scores": {"productKnowledge": 15, "presentationSkills": 15, "salesProcess": 15, "expertise": 15, "closingAbility": 15}, "totalScore": 75, "summary": {"strengths": "...", "improvements": "..."}}`;
            
            const evaluationHistory = [...conversationHistory];
            evaluationHistory.push({ role: 'user', parts: [{ text: evaluationPrompt }] });

            const rawResponse = await getAIResponse(evaluationHistory);
            
            try {
                const jsonResponse = rawResponse.replace(/^```json\s*|```$/g, '').trim();
                const evaluationData = JSON.parse(jsonResponse);
                displayEvaluation(evaluationData);
            } catch (error) {
                console.error("Error parsing evaluation JSON:", error, "Raw text:", rawResponse);
                displayEvaluation({ error: `ไม่สามารถสร้างผลการประเมินได้: ${error.message}` });
            }
        }

        function displayEvaluation(data) {
             if (data.error) {
                evaluationContent.innerHTML = `<p class="text-red-500">${data.error}</p>`;
            } else {
                const totalScoreClass = data.totalScore >= 60 ? 'text-green-500' : data.totalScore >= 45 ? 'text-yellow-500' : 'text-red-500';
                evaluationContent.innerHTML = `
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold">คะแนนรวม</h3>
                        <p class="text-6xl font-bold ${totalScoreClass}">${data.totalScore} <span class="text-3xl font-medium text-slate-500">/ 75</span></p>
                    </div>
                     <div class="mt-6 pt-6 border-t border-slate-200 space-y-4">
                        <div><h4 class="text-xl font-bold text-green-600 mb-2"><i class="fas fa-check-circle mr-2"></i>จุดแข็ง</h4><p class="text-slate-700 bg-slate-100 p-3 rounded-lg">${data.summary.strengths}</p></div>
                        <div><h4 class="text-xl font-bold text-yellow-600 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>สิ่งที่ควรปรับปรุง</h4><p class="text-slate-700 bg-slate-100 p-3 rounded-lg">${data.summary.improvements}</p></div>
                    </div>
                `;
            }
            evaluationModal.classList.remove('hidden');
            evaluationModal.classList.add('flex');
        }

        window.closeEvaluationModalAndReset = () => {
            evaluationModal.classList.add('hidden');
            evaluationModal.classList.remove('flex');
            roleplayView.classList.add('hidden');
            mainContent.classList.remove('hidden');
        };

        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'th-TH';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                statusIndicator.textContent = 'ประมวลผล...';
                
                addUserMessage(chatContainer, transcript);
                handleUserTurn(transcript);
            };
            
            // --- FIX: Auto-Retry on Network Error ---
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let errorMessage = `เกิดข้อผิดพลาด: ${event.error}`;

                if (event.error === 'network') {
                    errorMessage = 'การเชื่อมต่อขัดข้อง กำลังลองอีกครั้ง...';
                    // Automatically retry after 2 seconds for network errors
                    setTimeout(() => {
                        if (!isRecording && !isEvaluationInProgress) {
                            statusIndicator.textContent = 'กำลังพยายามเชื่อมต่อใหม่...';
                            try {
                                recognition.start();
                            } catch(e) {
                                console.error("Retry failed:", e);
                            }
                        }
                    }, 2500);
                } else if (event.error === 'no-speech') {
                    errorMessage = 'ไม่พบเสียงพูด กรุณาลองอีกครั้ง';
                     // When the AI finishes speaking, it will auto-listen again, so no need to auto-retry here.
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'ไม่สามารถเข้าถึงไมโครโฟนได้';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'กรุณาอนุญาตให้ใช้ไมโครโฟน';
                    micBtn.disabled = true; // Permanently disable if not allowed
                }
                
                statusIndicator.textContent = errorMessage;
            };

            recognition.onstart = () => {
                isRecording = true;
                statusIndicator.textContent = 'กำลังฟัง... พูดได้เลย';
                micBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                micBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                micBtn.innerHTML = '<i class="fas fa-stop"></i>';
            };

            recognition.onend = () => {
                isRecording = false;
                // Don't change status text here if an error is being displayed
                if (!statusIndicator.textContent.startsWith('เกิดข้อผิดพลาด') && !statusIndicator.textContent.startsWith('การเชื่อมต่อขัดข้อง')) {
                   if (!isEvaluationInProgress) {
                        statusIndicator.textContent = 'แตะไมโครโฟนเพื่อเริ่มพูด';
                   }
                }
                micBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                micBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };

        } else {
            micBtn.disabled = true;
            statusIndicator.textContent = 'ขออภัย บราวเซอร์ของคุณไม่รองรับการแปลงเสียงพูด';
        }

        micBtn.addEventListener('click', () => {
            if (!recognition) return;

            // Stop any speaking AI before recording
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Could not start recognition:", e);
                    statusIndicator.textContent = 'ไม่สามารถเริ่มการบันทึกเสียงได้';
                }
            }
        });
        
        async function callGemini(payload) {
            const API_KEY = ""; // This will be provided by the execution environment.
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: response.statusText }}));
                    throw new Error(`API error (${response.status}): ${errorData.error.message}`);
                }
                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                    return "ขออภัยค่ะ AI ไม่สามารถตอบกลับได้ในขณะนี้";
                }
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `ขออภัย, เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}.`;
            }
        }

    </script>
</body>
</html>

